<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E資格クエスト RPG (Test)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
        body { background-color: #111; color: #fff; font-family: 'DotGothic16', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; overflow: hidden; touch-action: none; }
        #game-wrapper { position: relative; width: 100%; max-width: 480px; aspect-ratio: 1/1; border: 2px solid #fff; background: #000; }
        canvas { display: block; width: 100%; height: 100%; }
        #start-screen { position: absolute; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #start-btn { padding: 20px 40px; font-size: 1.5rem; border: 2px solid #fff; background: #222; color: #fff; cursor: pointer; }
        /* 簡易表示のためCSSは最小限にしています */
        .overlay { position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.9); border: 2px solid #fff; padding: 10px; display: none; }
        #controller { width: 100%; max-width: 480px; height: 150px; background: #222; border-top: 2px solid #555; display:grid; grid-template-columns: 1fr 1fr;}
        .d-pad { display: grid; grid-template-areas: ". up ." "left . right" ". down ."; gap: 5px; justify-self: center; align-self: center; }
        .d-btn { width: 40px; height: 40px; background: #444; border: 1px solid #fff; text-align: center; line-height: 40px; user-select: none; }
        .a-btn { width: 60px; height: 60px; background: #833; border-radius: 50%; border: 2px solid #fff; justify-self: center; align-self: center; line-height: 60px; text-align: center; user-select: none; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="480" height="480"></canvas>
    <div id="start-screen">
        <h1>テスト版</h1>
        <button id="start-btn" onclick="startGame()">GAME START</button>
    </div>
    <div id="dialogue-box" class="overlay">
        <div id="dialogue-text"></div>
        <div style="text-align:right">▼ Aボタン</div>
    </div>
</div>

<div id="controller">
    <div class="d-pad">
        <div class="d-btn" style="grid-area:up" onclick="Input.move(0,-1)">↑</div>
        <div class="d-btn" style="grid-area:left" onclick="Input.move(-1,0)">←</div>
        <div class="d-btn" style="grid-area:right" onclick="Input.move(1,0)">→</div>
        <div class="d-btn" style="grid-area:down" onclick="Input.move(0,1)">↓</div>
    </div>
    <div class="a-btn" onclick="Input.act()">A</div>
</div>

<script>
// === 画像設定 (なければ四角になります) ===
const IMAGES = { hero: "hero.png", villager: "sage.png", floor: "floor.png" };

// === テスト用データ（ここは絶対にエラーが出ない最小限です） ===
const LECTURES = { 1: ["これはテスト講義じゃ。"] };
const DB = [ { sid: 1, q: "テスト問題", a: ["正解","誤","誤","誤"], exp: "解説" } ];

const MAP = [
    [1,1,1,1,1],
    [1,0,2,0,1],
    [1,0,0,0,1],
    [1,0,0,0,1],
    [1,1,1,1,1]
];

// === システム ===
const cvs = document.getElementById('gameCanvas');
const ctx = cvs.getContext('2d');
const TILE = 96; // テスト用に大きく
const assets = {};
for(let k in IMAGES){ assets[k]=new Image(); assets[k].src=IMAGES[k]; }

let player = { x: 1, y: 2 };
let mode = 'map';

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    draw();
}

const Input = {
    move(dx, dy) {
        if(mode !== 'map') return;
        let nx = player.x + dx;
        let ny = player.y + dy;
        if(MAP[ny] && MAP[ny][nx] !== 1) { player.x = nx; player.y = ny; }
        draw();
    },
    act() {
        if(mode === 'map') {
            // 簡易会話
            if(MAP[player.y][player.x+1] === 2 || MAP[player.y][player.x-1] === 2 || MAP[player.y-1][player.x] === 2) {
                mode = 'talk';
                document.getElementById('dialogue-box').style.display = 'block';
                document.getElementById('dialogue-text').innerText = "テスト成功じゃ！";
            }
        } else {
            mode = 'map';
            document.getElementById('dialogue-box').style.display = 'none';
        }
    }
};

function draw() {
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,480,480);
    for(let y=0; y<5; y++) {
        for(let x=0; x<5; x++) {
            let t = MAP[y][x];
            let col = t===1 ? '#555' : '#222';
            ctx.fillStyle = col; ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
            ctx.strokeRect(x*TILE, y*TILE, TILE, TILE);
            if(t===2) { ctx.fillStyle='#ff0'; ctx.fillRect(x*TILE+10, y*TILE+10, TILE-20, TILE-20); }
        }
    }
    ctx.fillStyle = '#0af';
    ctx.fillRect(player.x*TILE+10, player.y*TILE+10, TILE-20, TILE-20);
}
</script>
</body>
</html>
