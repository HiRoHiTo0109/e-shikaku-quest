<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E資格クエスト RPG</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');

        :root {
            --bg-color: #050505;
            --win-bg: #111;
            --text-color: #e0e0e0;
            --accent-color: #4db8ff;
            --danger-color: #ff4444;
            --sage-color: #ffd700;
            --base-font-size: 16px;
            --btn-padding: 12px;
            --window-width: 750px;
            --char-size: 220px;
        }

        @media (max-width: 600px) {
            :root {
                --base-font-size: 14px;
                --btn-padding: 16px;
                --window-width: 100%;
                --char-size: 130px;
            }
            .game-window { height: 100dvh; border-radius: 0 !important; border:none !important;}
            .stage-grid { grid-template-columns: 1fr 1fr !important; }
        }

        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: 'DotGothic16', sans-serif; font-size: var(--base-font-size);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            height: 100vh; margin: 0; overflow: hidden; touch-action: none;
        }

        /* ゲーム画面 */
        #game-wrapper {
            position: relative; width: 100%; max-width: 480px; aspect-ratio: 1 / 1;
            border: 2px solid #fff; background-color: #000; margin-bottom: 10px;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* コントローラー */
        #controller {
            width: 100%; max-width: 480px; height: 180px;
            display: grid; grid-template-columns: 1fr 1fr; padding: 10px;
            box-sizing: border-box; background: #222; border-top: 2px solid #555;
        }
        .d-pad {
            display: grid; grid-template-areas: ". up ." "left . right" ". down .";
            gap: 5px; width: 150px; height: 150px; justify-self: center; align-self: center;
        }
        .d-btn {
            width: 50px; height: 50px; background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; user-select: none; cursor: pointer;
        }
        .d-btn:active { background: rgba(255, 255, 255, 0.5); }
        .action-pad { display: flex; justify-content: center; align-items: center; }
        .a-btn {
            width: 80px; height: 80px; background: rgba(255, 100, 100, 0.3);
            border: 4px solid rgba(255, 100, 100, 0.8); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: bold; user-select: none; cursor: pointer;
        }
        .a-btn:active { background: rgba(255, 100, 100, 0.6); }

        /* UIオーバーレイ */
        .overlay {
            position: absolute; bottom: 10px; left: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.9); border: 2px solid #fff; border-radius: 8px;
            padding: 15px; display: none; font-size: 1rem; line-height: 1.5; z-index: 10;
        }
        #battle-ui { top: 10px; bottom: 10px; display: none; flex-direction: column; justify-content: space-between; }
        .hp-bar-frame { width: 100%; height: 10px; background: #333; border: 1px solid #fff; margin-bottom: 5px; }
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .hp-green { background: #0f0; } .hp-red { background: #f00; }
        .enemy-display { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .enemy-img-large { width: 120px; height: 120px; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 0 10px red); }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .btn { background: #222; color: white; border: 2px solid #fff; padding: 10px; font-family: inherit; cursor: pointer; text-align: left; }
        .btn.correct { background: #050; border-color: #0f0; } .btn.wrong { background: #500; border-color: #f00; }

        /* スタート画面 */
        #start-screen {
            position: absolute; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #start-btn { padding: 20px 40px; font-size: 1.5rem; border: 2px solid #fff; background: #222; color: #fff; cursor: pointer; }

    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="480" height="480"></canvas>

    <div id="start-screen">
        <h1 style="color:#4db8ff; margin-bottom:20px;">E資格クエスト</h1>
        <button id="start-btn" onclick="startGame()">GAME START</button>
        <p style="color:#888; margin-top:10px;">(音が出ます)</p>
    </div>

    <div id="dialogue-box" class="overlay">
        <div id="dialogue-text">...</div>
        <div style="text-align: right; font-size: 0.8rem; color: #aaa; margin-top:5px;">▼ 進む(Aボタン)</div>
    </div>

    <div id="battle-ui" class="overlay">
        <div>
            <div id="enemy-name">スライム</div>
            <div class="hp-bar-frame"><div id="enemy-hp" class="hp-bar-fill hp-red"></div></div>
        </div>
        <div class="enemy-display">
            <img id="battle-enemy-img" src="" alt="ENEMY" class="enemy-img-large">
            <div id="battle-msg" style="margin-top: 10px; min-height: 1.5em; text-align: center;">現れた！</div>
        </div>
        <div>
            <div style="display: flex; justify-content: space-between;"><span>勇者</span><span id="player-hp-text">HP: 100</span></div>
            <div class="hp-bar-frame"><div id="player-hp" class="hp-bar-fill hp-green"></div></div>
            <div id="quiz-area" style="display:none; margin-top: 10px;">
                <div id="quiz-text" style="margin-bottom:5px; font-size:0.95rem;">問題</div>
                <div id="quiz-options" class="quiz-options"></div>
            </div>
            <button id="battle-next-btn" class="btn" style="width:100%; display:none; text-align:center;" onclick="Battle.next()">次へ</button>
        </div>
    </div>
</div>

<div id="controller">
    <div class="d-pad">
        <div class="d-btn" style="grid-area: up;" ontouchstart="Input.startMove(0, -1)" onmousedown="Input.startMove(0, -1)" ontouchend="Input.stopMove()" onmouseup="Input.stopMove()">↑</div>
        <div class="d-btn" style="grid-area: left;" ontouchstart="Input.startMove(-1, 0)" onmousedown="Input.startMove(-1, 0)" ontouchend="Input.stopMove()" onmouseup="Input.stopMove()">←</div>
        <div class="d-btn" style="grid-area: right;" ontouchstart="Input.startMove(1, 0)" onmousedown="Input.startMove(1, 0)" ontouchend="Input.stopMove()" onmouseup="Input.stopMove()">→</div>
        <div class="d-btn" style="grid-area: down;" ontouchstart="Input.startMove(0, 1)" onmousedown="Input.startMove(0, 1)" ontouchend="Input.stopMove()" onmouseup="Input.stopMove()">↓</div>
    </div>
    <div class="action-pad">
        <div class="a-btn" onclick="Input.triggerAction()">A</div>
    </div>
</div>

<script>
// --- 画像設定 (4方向に対応) ---
const IMAGES = {
    // 勇者の4方向
    hero_down: "hero_down.png",
    hero_up: "hero_up.png",
    hero_left: "hero_left.png",
    hero_right: "hero_right.png",
    
    // その他
    villager: "sage.png",
    slime: "slime.png",
    boss: "boss.png",
    floor: "floor.png",
    wall: "wall.png"
};

// --- 問題データ (前回のデータをコピペしてください) ---
const DB = [
    { sid: 13, q: 'CNNのプーリング層の役割は？', a: ['位置ズレ不変性の獲得', '特徴強調', 'ch数変更', '非線形変換'], exp: '微小な平行移動を吸収します。' },
    { sid: 1, q: '行列Aの固有値をλ、固有ベクトルをxとした時、成り立つ式は？', a: ['Ax = λx', 'Ax = x + λ', 'A = λx', 'x = Aλ'], exp: '固有値定義の基本です。' }
];

const LECTURES = [
    "線形代数はAIの言語じゃ。行列の積計算は基本中の基本じゃぞ。",
    "過学習を防ぐにはドロップアウトや正則化が有効じゃ。",
    "CNNは画像認識に強い。畳み込みで特徴を抽出するのじゃ。",
    "強化学習は報酬を最大化するように行動を学ぶのじゃ。",
    "北の草原にはスライムが出るそうじゃ。基礎問題を出してくるぞ。",
    "東の洞窟には魔王がおる... 心してかかるのじゃ。",
    "疲れたら宿屋で休むといい。HPが全回復するぞ。"
];

const MAP_VILLAGE = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,3,3,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,3,3,1,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,2,1,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const MAP_FIELD = [
    [1,1,1,1,1,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 48;

const assets = {};
function loadAssets() {
    for (let key in IMAGES) {
        const img = new Image(); img.src = IMAGES[key]; assets[key] = img;
    }
}
loadAssets();

const Sound = {
    ctx: null, osc: null, intervalId: null, isPlaying: false,
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    playBGM(type) {
        if (!this.ctx) this.init(); if (this.ctx.state === 'suspended') this.ctx.resume();
        this.stopBGM();
        let melody = [], tempo = 150;
        if (type === 'village') { melody = [261, 329, 392, 329, 261, 329, 392, 329, 440, 349, 261, 349, 440, 349, 293, 247]; tempo = 300; }
        else if (type === 'field') { melody = [392, 392, 440, 523, 587, 523, 440, 392, 392, 330, 392, 523]; tempo = 200; }
        else if (type === 'battle') { melody = [110, 110, 130, 110, 146, 110, 130, 110, 164, 110, 146, 110]; tempo = 100; }
        else if (type === 'boss') { melody = [65, 73, 82, 73, 65, 73, 82, 97]; tempo = 120; }
        let noteIndex = 0;
        const playNote = () => {
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.type = (type === 'boss' || type === 'battle') ? 'sawtooth' : 'triangle';
            osc.frequency.value = melody[noteIndex];
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + (tempo/1000)*0.9);
            osc.start(); osc.stop(this.ctx.currentTime + (tempo/1000));
            noteIndex = (noteIndex + 1) % melody.length;
        };
        playNote(); this.intervalId = setInterval(playNote, tempo); this.isPlaying = true;
    },
    stopBGM() { if (this.intervalId) clearInterval(this.intervalId); this.isPlaying = false; },
    playSE(type) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
        osc.connect(gain); gain.connect(this.ctx.destination);
        const now = this.ctx.currentTime;
        if (type === 'decide') {
            osc.frequency.setValueAtTime(880, now); gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'damage') {
            osc.type = 'square'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(50, now + 0.2);
            gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0.01, now + 0.2); osc.start(now); osc.stop(now + 0.2);
        } else if (type === 'win') {
            this.stopBGM();
            [523, 659, 783, 1046].forEach((f, i) => {
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination); o.type = 'square'; o.frequency.value = f;
                g.gain.value = 0.1; g.gain.linearRampToValueAtTime(0, now + i*0.1 + 0.3);
                o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.3);
            });
            setTimeout(() => this.resumeMapBGM(), 2000);
        }
    },
    resumeMapBGM() { if (Game.mapType === 'village') this.playBGM('village'); else this.playBGM('field'); }
};

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    Sound.init(); Sound.playBGM('village');
}

function drawTile(key, x, y, fallbackColor) {
    const px = x * TILE_SIZE; const py = y * TILE_SIZE; const img = assets[key];
    if (img && img.complete && img.naturalHeight !== 0) ctx.drawImage(img, px, py, TILE_SIZE, TILE_SIZE);
    else { ctx.fillStyle = fallbackColor; ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE); ctx.strokeStyle="rgba(0,0,0,0.3)"; ctx.strokeRect(px, py, TILE_SIZE, TILE_SIZE); }
}

const Game = { mode: 'map', mapData: MAP_VILLAGE, mapType: 'village' };
const Player = {
    x: 10, y: 5, hp: 100, maxHp: 100, dir: 'down',
    move(dx, dy) {
        if (Game.mode !== 'map') return;
        const nextX = this.x + dx; const nextY = this.y + dy;
        // 向き更新
        if(dx>0) this.dir='right'; if(dx<0) this.dir='left'; if(dy>0) this.dir='down'; if(dy<0) this.dir='up';
        
        const tile = getTile(nextX, nextY);
        if (tile === 1) return;
        this.x = nextX; this.y = nextY;
        this.checkStepEvent(tile, nextX, nextY);
    },
    checkStepEvent(tile, x, y) {
        if (tile === 5) {
            if (Game.mapType === 'village') { Game.mapData = MAP_FIELD; Game.mapType = 'field'; this.x = 10; this.y = 1; Sound.playBGM('field'); }
            else { Game.mapData = MAP_VILLAGE; Game.mapType = 'village'; this.x = 10; this.y = 8; Sound.playBGM('village'); }
            return;
        }
        if (tile === 4) { Battle.start('boss'); return; }
        if (Game.mapType === 'field' && Math.random() < 0.15) { Battle.start('slime'); }
    },
    interact() {
        if (Game.mode !== 'map') { if (Game.mode === 'dialogue') Dialogue.next(); return; }
        let tx = this.x, ty = this.y;
        if (this.dir === 'up') ty--; if (this.dir === 'down') ty++; if (this.dir === 'left') tx--; if (this.dir === 'right') tx++;
        const tile = getTile(tx, ty);
        if (tile === 2) { Sound.playSE('decide'); const text = LECTURES[Math.floor(Math.random() * LECTURES.length)]; Dialogue.show("村人", text); }
        else if (tile === 3) { Sound.playSE('decide'); this.hp = this.maxHp; Dialogue.show("宿屋の主人", "よく休めたかい？ HPが全回復したよ！"); }
    }
};

function getTile(x, y) {
    if (y < 0 || y >= Game.mapData.length || x < 0 || x >= Game.mapData[0].length) return 1;
    return Game.mapData[y][x];
}

const Input = {
    moveInterval: null,
    startMove(dx, dy) {
        if(Game.mode !== 'map') return;
        Player.move(dx, dy);
        if (this.moveInterval) clearInterval(this.moveInterval);
        this.moveInterval = setInterval(() => { if(Game.mode === 'map') Player.move(dx, dy); }, 150);
    },
    stopMove() { if (this.moveInterval) clearInterval(this.moveInterval); this.moveInterval = null; },
    triggerAction() { Player.interact(); }
};

window.addEventListener('keydown', e => {
    if (e.repeat) return;
    if (e.key === 'ArrowUp') Input.startMove(0, -1);
    if (e.key === 'ArrowDown') Input.startMove(0, 1);
    if (e.key === 'ArrowLeft') Input.startMove(-1, 0);
    if (e.key === 'ArrowRight') Input.startMove(1, 0);
    if (e.key === ' ' || e.key === 'Enter') Input.triggerAction();
});
window.addEventListener('keyup', () => Input.stopMove());

const Battle = {
    enemy: null, q_list: [],
    start(type) {
        Input.stopMove(); Game.mode = 'battle'; document.getElementById('battle-ui').style.display = 'flex';
        if (type === 'boss') { Sound.playBGM('boss'); this.enemy = { name: "魔王", hp: 100, maxHp: 100, atk: 30, img: IMAGES.boss }; this.q_list = [...DB].sort(() => Math.random() - 0.5); }
        else { Sound.playBGM('battle'); this.enemy = { name: "スライム", hp: 20, maxHp: 20, atk: 10, img: IMAGES.slime }; this.q_list = [DB[Math.floor(Math.random() * DB.length)]]; }
        document.getElementById('enemy-name').innerText = this.enemy.name;
        document.getElementById('battle-enemy-img').src = this.enemy.img;
        this.updateUI(); this.log(`${this.enemy.name} があらわれた！`);
        setTimeout(() => this.nextQuestion(), 1500);
    },
    nextQuestion() {
        if (this.q_list.length === 0) { if (this.enemy.hp > 0) { this.end("勝負はお預けだ。"); Sound.resumeMapBGM(); } return; }
        const q = this.q_list.pop();
        document.getElementById('quiz-area').style.display = 'block'; document.getElementById('battle-next-btn').style.display = 'none';
        document.getElementById('quiz-text').innerText = q.q;
        const optsDiv = document.getElementById('quiz-options'); optsDiv.innerHTML = '';
        const options = q.a.map((txt, i) => ({ txt, isC: i===0 })).sort(() => Math.random() - 0.5);
        options.forEach(opt => {
            const btn = document.createElement('button'); btn.className = 'btn'; btn.innerText = opt.txt;
            btn.onclick = () => this.answer(btn, opt.isC, q.exp); optsDiv.appendChild(btn);
        });
        this.log("どうする？");
    },
    answer(btn, isCorrect, exp) {
        const btns = document.querySelectorAll('#quiz-options button'); btns.forEach(b => b.disabled = true);
        if (isCorrect) { btn.classList.add('correct'); Sound.playSE('decide'); this.log(`正解！ ダメージ！`); this.enemy.hp -= 10; }
        else { btn.classList.add('wrong'); Sound.playSE('damage'); this.log(`不正解... (${exp})`); Player.hp -= this.enemy.atk; }
        this.updateUI();
        setTimeout(() => {
            if (Player.hp <= 0) { this.end("GAME OVER..."); Sound.stopBGM(); Player.hp = 1; Player.x = 10; Player.y = 5; Game.mapData = MAP_VILLAGE; Game.mapType = 'village'; setTimeout(() => Sound.playBGM('village'), 2000); }
            else if (this.enemy.hp <= 0) { this.end(`${this.enemy.name} を倒した！`); Sound.playSE('win'); }
            else { document.getElementById('quiz-area').style.display = 'none'; document.getElementById('battle-next-btn').style.display = 'block'; }
        }, 1500);
    },
    next() { this.nextQuestion(); },
    end(msg) { this.log(msg); setTimeout(() => { document.getElementById('battle-ui').style.display = 'none'; Game.mode = 'map'; }, 2000); },
    updateUI() {
        document.getElementById('enemy-hp').style.width = Math.max(0, (this.enemy.hp / this.enemy.maxHp) * 100) + "%";
        document.getElementById('player-hp').style.width = Math.max(0, (Player.hp / Player.maxHp) * 100) + "%";
        document.getElementById('player-hp-text').innerText = `HP: ${Math.max(0, Player.hp)}`;
    },
    log(text) { document.getElementById('battle-msg').innerText = text; }
};

const Dialogue = {
    show(name, text) { Game.mode = 'dialogue'; document.getElementById('dialogue-box').style.display = 'block'; document.getElementById('dialogue-text').innerHTML = `<strong style="color:#ffd700">${name}</strong><br>${text}`; },
    next() { document.getElementById('dialogue-box').style.display = 'none'; Game.mode = 'map'; }
};

function draw() {
    ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    const camX = Math.max(0, Math.min(Player.x * TILE_SIZE - canvas.width / 2 + TILE_SIZE/2, Game.mapData[0].length * TILE_SIZE - canvas.width));
    const camY = Math.max(0, Math.min(Player.y * TILE_SIZE - canvas.height / 2 + TILE_SIZE/2, Game.mapData.length * TILE_SIZE - canvas.height));
    ctx.save(); ctx.translate(-camX, -camY);
    for (let y = 0; y < Game.mapData.length; y++) {
        for (let x = 0; x < Game.mapData[0].length; x++) {
            const tile = Game.mapData[y][x];
            if (tile === 0) drawTile('floor', x, y, '#222');
            if (tile === 1) drawTile('wall', x, y, '#555');
            if (tile === 2) drawTile('villager', x, y, '#ff0');
            if (tile === 3) { drawTile('floor', x, y, '#222'); ctx.font="20px sans-serif"; ctx.fillStyle="#fff"; ctx.fillText("INN", x*TILE_SIZE+5, y*TILE_SIZE+30); }
            if (tile === 4) drawTile('boss', x, y, '#90f');
            if (tile === 5) { ctx.fillStyle='#afa'; ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE); }
        }
    }
    // 【変更点】プレイヤーの向きに応じた画像を描画
    const heroKey = `hero_${Player.dir}`;
    drawTile(heroKey, Player.x, Player.y, '#4db8ff');
    ctx.restore();
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>